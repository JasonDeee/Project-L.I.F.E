<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Test WebSocket Server</title>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
        background-color: #f5f5f5;
      }
      .container {
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }
      .status {
        padding: 10px;
        margin: 10px 0;
        border-radius: 4px;
        font-weight: bold;
      }
      .connected {
        background-color: #d4edda;
        color: #155724;
      }
      .disconnected {
        background-color: #f8d7da;
        color: #721c24;
      }
      .connecting {
        background-color: #fff3cd;
        color: #856404;
      }

      .input-group {
        margin: 20px 0;
      }
      input[type="text"] {
        width: 70%;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 16px;
      }
      button {
        width: 25%;
        padding: 10px;
        background-color: #007bff;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 16px;
        margin-left: 10px;
      }
      button:hover {
        background-color: #0056b3;
      }
      button:disabled {
        background-color: #6c757d;
        cursor: not-allowed;
      }

      .messages {
        height: 400px;
        overflow-y: auto;
        border: 1px solid #ddd;
        padding: 10px;
        background-color: #f8f9fa;
        margin: 20px 0;
      }
      .message {
        margin: 10px 0;
        padding: 8px;
        border-radius: 4px;
      }
      .user-message {
        background-color: #e3f2fd;
        text-align: right;
      }
      .server-message {
        background-color: #f3e5f5;
      }
      .system-message {
        background-color: #e8f5e8;
        font-style: italic;
      }
      .error-message {
        background-color: #ffebee;
        color: #c62828;
      }

      .controls {
        margin: 20px 0;
      }
      .controls button {
        width: auto;
        margin: 5px;
        padding: 8px 16px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>üîå WebSocket Server Test</h1>

      <div id="status" class="status disconnected">‚ùå Disconnected</div>

      <div class="controls">
        <button id="connectBtn" onclick="connect()">Connect</button>
        <button id="disconnectBtn" onclick="disconnect()" disabled>
          Disconnect
        </button>
        <button id="testBtn" onclick="testConnection()" disabled>
          Test Connection
        </button>
        <button id="clearBtn" onclick="clearMessages()">Clear Messages</button>
      </div>

      <div class="input-group">
        <input
          type="text"
          id="messageInput"
          placeholder="Nh·∫≠p tin nh·∫Øn..."
          disabled
        />
        <button id="sendBtn" onclick="sendMessage()" disabled>Send</button>
      </div>

      <div id="messages" class="messages"></div>

      <div>
        <h3>üìä Connection Info:</h3>
        <p><strong>Socket ID:</strong> <span id="socketId">-</span></p>
        <p>
          <strong>Server URL:</strong>
          <span id="serverUrl">http://localhost:8000</span>
        </p>
        <p><strong>Last Activity:</strong> <span id="lastActivity">-</span></p>
      </div>
    </div>

    <script>
      let socket = null;
      let messageId = 0;

      function updateStatus(status, message) {
        const statusEl = document.getElementById("status");
        statusEl.className = `status ${status}`;
        statusEl.textContent = message;
        document.getElementById("lastActivity").textContent =
          new Date().toLocaleTimeString();
      }

      function addMessage(type, content, timestamp = null) {
        const messagesEl = document.getElementById("messages");
        const messageEl = document.createElement("div");
        messageEl.className = `message ${type}-message`;

        const time = timestamp
          ? new Date(timestamp).toLocaleTimeString()
          : new Date().toLocaleTimeString();
        messageEl.innerHTML = `<strong>[${time}]</strong> ${content}`;

        messagesEl.appendChild(messageEl);
        messagesEl.scrollTop = messagesEl.scrollHeight;
      }

      function connect() {
        if (socket && socket.connected) {
          addMessage("system", "Already connected!");
          return;
        }

        updateStatus("connecting", "üîÑ Connecting...");
        addMessage("system", "Connecting to server...");

        socket = io("http://localhost:8000", {
          transports: ["websocket"],
          timeout: 5000,
          forceNew: true,
        });

        // Connection events
        socket.on("connect", () => {
          updateStatus("connected", "‚úÖ Connected");
          addMessage("system", `Connected! Socket ID: ${socket.id}`);
          document.getElementById("socketId").textContent = socket.id;

          // Enable controls
          document.getElementById("connectBtn").disabled = true;
          document.getElementById("disconnectBtn").disabled = false;
          document.getElementById("testBtn").disabled = false;
          document.getElementById("sendBtn").disabled = false;
          document.getElementById("messageInput").disabled = false;
        });

        socket.on("disconnect", (reason) => {
          updateStatus("disconnected", "‚ùå Disconnected");
          addMessage("system", `Disconnected: ${reason}`);
          document.getElementById("socketId").textContent = "-";

          // Disable controls
          document.getElementById("connectBtn").disabled = false;
          document.getElementById("disconnectBtn").disabled = true;
          document.getElementById("testBtn").disabled = true;
          document.getElementById("sendBtn").disabled = true;
          document.getElementById("messageInput").disabled = true;
        });

        socket.on("connect_error", (error) => {
          updateStatus("disconnected", "‚ùå Connection Error");
          addMessage("error", `Connection error: ${error.message}`);
        });

        // Handshake events
        socket.on("handshake_response", (data) => {
          addMessage("system", `Handshake: ${data.message}`);
          if (data.success) {
            addMessage("system", `Server date: ${data.serverDate}`);
            addMessage(
              "system",
              `Chat history: ${data.chatHistory?.length || 0} messages`
            );
          } else {
            addMessage("error", `Handshake failed: ${data.error}`);
          }
        });

        // Message events
        socket.on("message_confirmed", (data) => {
          addMessage("system", `‚úÖ Message confirmed: ${data.messageId}`);
        });

        socket.on("message_logged", (data) => {
          addMessage("system", `üìù Message logged: ${data.type}`);
        });

        socket.on("assistant_message", (data) => {
          addMessage("server", `ü§ñ Assistant: ${data.content}`);
        });

        socket.on("error", (data) => {
          addMessage("error", `‚ùå Server error: ${data.message}`);
        });

        socket.on("connection_status", (data) => {
          addMessage("system", `üì° ${data.message}`);
        });

        // Start handshake
        socket.emit("client_handshake", {
          clientDate: new Date().toISOString(),
          userAgent: navigator.userAgent,
          sessionId: socket.id || "pending",
        });
      }

      function disconnect() {
        if (socket) {
          socket.disconnect();
          socket = null;
        }
      }

      function testConnection() {
        if (socket && socket.connected) {
          socket.emit("connection_test");
          addMessage("system", "Testing connection...");
        }
      }

      function sendMessage() {
        const input = document.getElementById("messageInput");
        const message = input.value.trim();

        if (!message) {
          addMessage("error", "Please enter a message");
          return;
        }

        if (!socket || !socket.connected) {
          addMessage("error", "Not connected to server");
          return;
        }

        const messageData = {
          content: message,
          timestamp: new Date().toISOString(),
          messageId: ++messageId,
        };

        addMessage("user", `You: ${message}`);
        input.value = "";

        // Send with acknowledgment
        socket.emit("user_message", messageData, (ack) => {
          if (ack && ack.ok) {
            addMessage(
              "system",
              `‚úÖ Server acknowledged message ${ack.messageId}`
            );
          } else {
            addMessage("error", "‚ùå Server did not acknowledge message");
          }
        });

        addMessage("system", `üì§ Sending message ${messageId}...`);
      }

      function clearMessages() {
        document.getElementById("messages").innerHTML = "";
      }

      // Enter key to send message
      document
        .getElementById("messageInput")
        .addEventListener("keypress", (e) => {
          if (e.key === "Enter") {
            sendMessage();
          }
        });

      // Auto-connect on page load
      window.addEventListener("load", () => {
        addMessage("system", "Page loaded. Click Connect to start.");
      });
    </script>
  </body>
</html>
